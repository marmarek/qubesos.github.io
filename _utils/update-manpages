#!/bin/sh

set -e

if [ $# -lt 2 ]; then
    echo "Usage: $0 <sourcedir> <destdir>"
    echo ""
    echo "Examples:"
    echo "  $0 \\"
    echo "      qubes-core-admin/doc/qvm-tools \\"
    echo "      _doc/reference/tools/3.2/dom0"
    echo "  $0 \\"
    echo "      qubes-core-admin/doc/qubes-tools \\"
    echo "      _doc/reference/tools/3.2/dom0"
    echo "  $0 \\"
    echo "      qubes-core-agent-linux/doc/vm-tools \\"
    echo "      _doc/reference/tools/3.2/domU"
    echo ""
    echo "Note: it doesn't remove obsolete pages, nor update index. You need to"
    echo "do that manually."
    exit 1
fi

srcdir="$1"
dstdir="$2"

for input in "$srcdir"/*.rst; do
    echo "Processing $input..." >&2
    output="$dstdir/$(basename $input .rst).md"
    # save frontmatter, if any
    if [ -f "$output" ]; then
        grep -B 100 -A 1 '^---$' "$output" > "$output".frontmatter || :
    else
        title="$(basename $input .rst)"
        category="$(basename $dstdir)"
        cat >"$output".frontmatter <<EOF
---
layout: doc
title: $title
permalink: /doc/tools/3.2/$category/$title/
redirect_from:
- /doc/${category}-tools/$title/
- /en/doc/${category}-tools/$title/
---

EOF
    fi
    ( cat "$output".frontmatter; 
      printf '```\n';
      cat "$input";
      printf '```\n\n';
      printf -- '-----\n\n**Note:** The Markdown source of this page in ';
      printf '[`qubes-doc`] was generated by\nrunning the [`update-manpages`] ';
      printf 'script on `'$srcdir'`.\nIf you wish to update the contents of ';
      printf 'this page as it appears on the Qubes OS\nwebsite, please submit ';
      printf 'a pull request to change the appropriate file in\n`'$srcdir'`. ';
      printf 'Do not attempt to change the Markdown source\nof this page in ';
      printf '[`qubes-doc`] directly. All direct changes to the Markdown file ';
      printf 'will be\noverwritten the next time this page is regenerated.\n\n';
      printf '[`qubes-doc`]: https://github.com/QubesOS/qubes-doc/\n';
      printf '[`update-manpages`]: https://github.com/QubesOS/qubesos.github.';
      printf 'io/blob/master/_utils/update-manpages\n\n';
    ) > "$output"
    rm -f "$output".frontmatter
done
