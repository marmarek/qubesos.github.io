#!/bin/sh
# Updates man pages for Qubes 4.0

set -e

if [ $# -lt 2 ]; then
    echo "Usage: $0 <sourcedir> <destdir>"
    echo ""
    echo "Example:"
    echo "  $ cd qubes-core-agent-linux/"
    echo "  $ git checkout master"
    echo "  $ cd .."
    echo "  $0  qubes-core-agent-linux/doc/vm-tools/ _doc/reference/tools/4.0/domU"
    echo ""
    echo "Note: This tool doesn't remove obsolete pages or update the index. "
    echo "You need to do that manually."
    exit 1
fi

srcdir="$1"
dstdir="$2"

for input in "$srcdir"*.rst; do
    echo "Processing $input..." >&2
    output="$dstdir/$(basename $input .rst).md"
    # save frontmatter, if any
    if [ -f "$output" ]; then
        grep -B 100 -A 1 '^---$' "$output" > "$output".frontmatter || :
    else
        title="$(basename $input .rst)"
        category="$(basename $dstdir)"
        cat >"$output".frontmatter <<EOF
---
layout: doc
title: $title
permalink: /doc/tools/4.0/$category/$title/
---

EOF
    fi
    ( cat "$output".frontmatter; 
      printf '```\n';
      cat "$input";
      printf '```\n\n';
      printf -- '-----\n\n**Note:** ';
      printf 'The Markdown source of this page in [`qubes-doc`] was generated by running the [`update-manpages-4-0`] script on `'$srcdir'`.\n';
      printf 'If you wish to update the contents of this page as it appears on the Qubes OS website, please submit a pull request to change the appropriate file in `'$srcdir'`.\n';
      printf 'Do not attempt to change the Markdown source of this page in [`qubes-doc`] directly.\n';
      printf 'All direct changes to the Markdown file will be overwritten the next time this page is regenerated.\n\n';
      printf '[`qubes-doc`]: https://github.com/QubesOS/qubes-doc/\n';
      printf '[`update-manpages-4-0`]: https://github.com/QubesOS/qubesos.github.io/blob/master/_utils/update-manpages-4-0\n\n';
    ) > "$output"
    rm -f "$output".frontmatter
done

